<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Fytotron Client – Protocol Editor (Simulation)</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<style>
  /* ================= FIXED WINDOW ================= */
  :root{
    --bg:#eef1f3; --panel:#ffffff; --bar:#cfd9eb; --field:#c6e6ee;
    --ink:#222; --b:#9aa5b1; --bd:#6b7a8a; --accent:#6e8fb5; --rule:#bac6d9;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px "Segoe UI",Tahoma,Arial,sans-serif;width:1200px;height:800px;overflow:hidden}

  /* ================= TOP TABS ================= */
  .tabs{height:48px;display:flex;align-items:flex-end;gap:8px;padding:0 8px}
  .tab{height:36px;padding:0 18px;border:1px solid var(--b);border-bottom:none;border-radius:4px 4px 0 0;background:#f6f7f9;display:flex;align-items:center}
  .tab.active{background:#fff;font-weight:600}

  /* ================= MAIN SPLIT ================= */
  .row{display:flex;gap:12px;padding:0 12px 12px;height:calc(100% - 48px)}
  .left{width:800px;background:var(--panel);border:1px solid var(--b);display:flex;flex-direction:column}
  .right{width:360px;margin-left:auto;background:var(--panel);border:1px solid var(--b);display:flex;flex-direction:column}

  /* toolbar */
  .toolbar{height:44px;background:var(--bar);border-bottom:1px solid var(--b);display:flex;align-items:center;padding:0 10px;gap:12px}
  .btn{min-width:110px;height:28px;border:1px solid var(--b);background:linear-gradient(#fff,#e6e9ee);border-radius:4px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .label{font-weight:600}
  .field{height:28px;width:140px;border:1px solid var(--bd);background:var(--field);border-radius:3px;text-align:center;line-height:28px}

  /* group tabs */
  .group-tabs{height:30px;display:flex;align-items:center;gap:6px;padding:6px 8px;background:#f3f3f3;border-bottom:1px solid var(--b);flex-wrap:wrap}
  .gtab{padding:4px 8px;border:1px solid var(--b);border-radius:4px;background:#eee;font-size:12px;cursor:pointer}
  .gtab.active{background:#fff;border-color:var(--accent)}

  /* workspace */
  .workspace{flex:1;background:#e6e6e6;margin:8px;border:1px solid var(--b);overflow:auto}
  .placeholder{height:100%;display:flex;align-items:center;justify-content:center;color:#777;font-style:italic}

  /* right panel */
  .right-head{padding:10px}
  .select{width:100%;height:30px;border:1px solid var(--b);border-radius:4px}
  .section{padding:8px 10px 4px}
  .rule{height:1px;background:var(--rule);margin:8px 0 12px}
  .section h5{margin:0;font-weight:600;color:#37455a}
  .file-row{display:flex;gap:12px;padding:0 10px 8px}
  .file-row .btn{min-width:90px}
  .prop{display:grid;grid-template-columns:120px 1fr auto;gap:8px;align-items:center;padding:6px 10px}
  .input, textarea{border:1px solid var(--bd);background:var(--field);border-radius:3px;padding:6px}
  textarea{height:90px;resize:none}
  .ro{background:#e9eef2;text-align:center}
  .instruction{margin-top:auto;border-top:1px solid var(--b);padding:10px;font-size:12px;color:#556;background:#f7f8fb}

  /* ================= MODALS ================= */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45)}
  .modal{width:760px;background:#4a5f73;padding:22px;border-radius:6px;box-shadow:0 8px 20px rgba(0,0,0,.35)}
  .modal-title{color:#fff;font-weight:600;text-align:center;margin:0 0 10px}
  .modal-inner{background:#f2f2f2;border:1px solid var(--bd);padding:14px}

  /* Variable manager content */
  .vm-body{display:grid;grid-template-columns:1fr 140px;gap:10px}
  .vg-tabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
  .vg-tab{padding:6px 10px;border:1px solid var(--b);background:#e7ebef;border-radius:4px;font-size:12px;cursor:pointer}
  .vg-tab.active{background:#fff;border-color:var(--accent)}
  .vg-col{background:#fff;border:1px solid var(--b);padding:8px;max-height:260px;overflow:auto}
  .pill-row{display:flex;align-items:center;gap:6px;margin:4px 0;}
  .pill{display:inline-block;background:#eaf3ff;border:1px solid #8aa4c2;padding:4px 8px;border-radius:4px;font-size:12px}
  .mini{min-width:70px;height:24px}
  .side-actions{display:flex;flex-direction:column;gap:8px}
  .footer-line{display:flex;justify-content:space-between;color:#555;font-size:12px;margin-top:6px}

  /* Sub-dialogs */
  .sub{width:680px}
  .sub-wide{width:820px}
  .sub-inner{background:#d6dee6;border:1px solid var(--bd);padding:16px;border-radius:6px}
  .sub-title{color:#fff;text-align:center;margin:0 0 10px}
  .listbox{background:#f7f9fb;border:1px solid var(--b);height:300px;overflow:auto;padding:10px}
  .chk{margin-right:8px}
  .flex-end{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
  .soft{opacity:.85}
</style>
</head>
<body>
  <!-- tabs -->
  <div class="tabs">
    <div class="tab">MAIN</div>
    <div class="tab">EXPERIMENT</div>
    <div class="tab active">PROTOCOL EDITOR</div>
    <div class="tab">DATA VIEWER</div>
    <div class="tab">CONTROLS</div>
    <div class="tab">SERVICE</div>
    <div class="tab">AUTHENTICATION</div>
  </div>

  <div class="row">
    <!-- LEFT workspace -->
    <div class="left">
      <div class="toolbar">
        <button class="btn" id="btnEditGroups">Edit Groups</button>
        <span class="label">Group duration:</span>
        <div class="field" id="groupDuration">--</div>
        <button class="btn" id="btnClearGroup" disabled>Clear Group</button>
        <button class="btn" id="btnAddPhase" disabled>Add Phase</button>
      </div>
      <div id="groupTabs" class="group-tabs" style="display:none;"></div>
      <div class="workspace" id="workspace">
        <div class="placeholder" id="blankState">Create a NEW protocol to initialize default groups.</div>
        <div id="phaseScroller" style="display:none; padding:10px;"></div>
      </div>
    </div>

    <!-- RIGHT properties -->
    <div class="right">
      <div class="right-head"><select class="select"><option>Fytotron</option></select></div>
      <div class="section"><div class="rule"></div><h5>Protocol File</h5></div>
      <div class="file-row">
        <button class="btn" id="btnNew">NEW</button>
        <button class="btn" id="btnErase">Erase</button>
        <button class="btn" id="btnLoad" disabled>Load..</button>
        <button class="btn" id="btnSave" disabled>Save..</button>
      </div>
      <div class="section"><div class="rule"></div><h5>Protocol Properties</h5></div>
      <div class="prop"><label>Description:</label><textarea id="desc"></textarea><div></div></div>
      <div class="prop"><label>Logic start time:</label><input id="logic" class="input" value="- not set -" /><button class="btn" id="btnEraseTime">Erase Time</button></div>
      <div class="prop"><label>Repeat:</label><input id="repeat" class="input" value="Infinitely times" /><button class="btn" id="btnSetInf">Set Infinitely</button></div>
      <div class="prop"><label>Duration:</label><input id="duration" class="input ro" value="0 hours" readonly /><div></div></div>
      <div class="instruction">Reminder: this is a **simulation**. Build groups/phases, then we will **download encoded JSON (.fyt)** that the real app can load.</div>
    </div>
  </div>

  <!-- Variable Management Modal -->
  <div class="overlay" id="dlgGroups">
    <div class="modal">
      <h3 class="modal-title">Fytotron – Protocol Variables Management</h3>
      <div class="modal-inner">
        <div class="vg-tabs" id="vgTabs"></div>
        <div class="vm-body">
          <div>
            <div class="vg-col" id="vgList"></div>
            <div class="footer-line"><span id="vmGroupName"></span><span id="vmVarCount"></span></div>
          </div>
          <div class="side-actions">
            <button class="btn" id="btnCreateGroup">Create Group</button>
            <button class="btn" id="btnDeleteGroup">Delete Group</button>
            <button class="btn" id="btnRenameGroup">Rename Group</button>
            <button class="btn" id="btnAddVariable">Add Variable</button>
          </div>
        </div>
        <div class="dlg-buttons"><button class="btn" id="btnCloseGroups">OK</button></div>
      </div>
    </div>
  </div>

  <!-- Sub: New Group Of Variables -->
  <div class="overlay" id="dlgNewGroup">
    <div class="modal sub">
      <h3 class="modal-title">New Group Of Variables</h3>
      <div class="modal-inner sub-inner">
        <div style="display:grid;grid-template-columns:100px 1fr 60px;align-items:center;gap:10px;">
          <label>Type:</label>
          <select id="ngType" class="select" style="height:32px"></select>
          <div></div>
          <label>Name:</label>
          <input id="ngName" class="input" />
          <div></div>
        </div>
        <div class="flex-end"><button class="btn" id="ngCancel">Cancel</button><button class="btn" id="ngOK">OK</button></div>
      </div>
    </div>
  </div>

  <!-- Sub: Choose target group -->
  <div class="overlay" id="dlgChooseGroup">
    <div class="modal sub-wide">
      <h3 class="modal-title">Choose targed group</h3>
      <div class="modal-inner sub-inner">
        <div class="listbox" id="cgList"></div>
        <div class="flex-end"><button class="btn" id="cgCancel">Cancel</button></div>
      </div>
    </div>
  </div>

  <!-- Sub: Add variable(s) to group (multi-select) -->
  <div class="overlay" id="dlgAddVar">
    <div class="modal sub-wide">
      <h3 class="modal-title">Choose variable(s) for group: <span id="avGroupName"></span></h3>
      <div class="modal-inner sub-inner">
        <div class="listbox" id="avList"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
          <div style="display:flex;gap:8px;">
            <button class="btn mini" id="avAll">SELECT ALL</button>
            <button class="btn mini" id="avNone">SELECT NONE</button>
          </div>
          <div class="soft">Number of all variables: <span id="avAllCount">0</span> &nbsp; | &nbsp; Number of selected variables: <span id="avSelCount">0</span></div>
        </div>
        <div class="flex-end"><button class="btn" id="avCancel">Cancel</button><button class="btn" id="avOK">OK</button></div>
      </div>
    </div>
  </div>

  <!-- Sub: Warning (no same-type group) -->
  <div class="overlay" id="dlgWarn">
    <div class="modal sub"><h3 class="modal-title">Notice</h3>
      <div class="modal-inner sub-inner">
        <div style="background:#f0f4f8;border:1px solid var(--b);padding:24px;text-align:center">Another group of same type doesn't exist.<br/>Create some before move variable.</div>
        <div class="flex-end"><button class="btn" id="warnOK">OK</button></div>
      </div>
    </div>
  </div>

<script>
// ================= DATA MODEL =================
const INVENTORY = {
  "CO2":["CO2"],
  "Cool White":["Cool White 1","Cool White 2"],
  "Deep-Red":["Deep-Red 1","Deep-Red 2"],
  "Far-Red":["Far-Red 1","Far-Red 2"],
  "Humidity":["Humidity"],
  "Hydroponics":["Hydroponics 1","Hydroponics 2"],
  "Temperature":["Temperature"]
};
const TAB_ORDER=["CO2","Cool White","Deep-Red","Far-Red","Humidity","Hydroponics","Temperature"];

let protocol=null;                 // becomes non-null after NEW
let groups=[];                     // {id,type,name,vars:[...],phases:[]}
let unassigned={};                 // {type: [varNames]}
let activeGroupId=null;

const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));

function sortGroups(){
  groups.sort((a,b)=>{
    const ai=TAB_ORDER.indexOf(a.type), bi=TAB_ORDER.indexOf(b.type);
    if(ai!==bi) return ai-bi; // group by type order
    return a.name.localeCompare(b.name); // within type by name
  });
}

function refreshUI(){
  sortGroups();
  const has=groups.length>0;
  $('#groupTabs').style.display=has?'flex':'none';
  $('#blankState').style.display=has?'none':'flex';
  $('#phaseScroller').style.display=has?'block':'none';
  $('#btnClearGroup').disabled=!has; $('#btnAddPhase').disabled=!has; $('#btnSave').disabled=!protocol || !isProtocolValid();
  renderTabs(); renderPhases(); buildVM();
}

function isProtocolValid(){
  const hasAll=TAB_ORDER.every(t=>groups.some(g=>g.type===t));
  const noneUnassigned=Object.values(unassigned).every(arr=>arr.length===0);
  return hasAll && noneUnassigned;
}

function renderTabs(){
  const bar=$('#groupTabs'); bar.innerHTML='';
  groups.forEach(g=>{
    const t=document.createElement('div'); t.className='gtab'+(g.id===activeGroupId?' active':'');
    t.textContent=g.name; t.onclick=()=>{activeGroupId=g.id; renderTabs(); renderPhases();};
    bar.appendChild(t);
  });
  const ag=groups.find(x=>x.id===activeGroupId);
  const hours=ag?ag.phases.reduce((s,p)=>s+(parseFloat(p.duration)||0),0):0;
  $('#groupDuration').textContent=ag?`${hours} hours`:'--';
}

function renderPhases(){
  const c=$('#phaseScroller'); c.innerHTML='';
  const g=groups.find(x=>x.id===activeGroupId); if(!g) return;
  const ph=document.createElement('div'); ph.className='placeholder'; ph.style.background='#fff'; ph.style.border='1px dashed var(--b)'; ph.style.height='120px'; ph.textContent='No phases yet. Click "Add Phase".'; c.appendChild(ph);
}

function createDefaultGroups(){
  groups=[]; unassigned={}; TAB_ORDER.forEach(t=> unassigned[t]=[]);
  TAB_ORDER.forEach(type=>{
    groups.push({id:crypto.randomUUID(), type, name:type, vars:INVENTORY[type].slice(), phases:[]});
  });
  activeGroupId=groups[0].id;
}

// ===== Variable Manager =====
let vmSelectedGroupId=null; // selected group (tab) in overlay

function buildVM(){
  const tabs=$('#vgTabs'); const list=$('#vgList'); if(!tabs||!list) return;
  tabs.innerHTML='';
  groups.forEach(g=>{
    const b=document.createElement('div'); b.className='vg-tab'+(g.id===vmSelectedGroupId?' active':''); b.textContent=g.name;
    b.onclick=()=>{vmSelectedGroupId=g.id; buildVM();};
    tabs.appendChild(b);
  });

  if(!vmSelectedGroupId && groups.length) vmSelectedGroupId=groups[0].id;
  const g=groups.find(x=>x.id===vmSelectedGroupId);

  list.innerHTML='';
  if(g){
    const title=document.createElement('div'); title.textContent=g.name; title.style.fontWeight='600'; title.style.margin='6px 0'; list.appendChild(title);
    if(g.vars.length===0){
      const empty=document.createElement('div'); empty.style.textAlign='center'; empty.style.color='#666'; empty.style.padding='20px 0'; empty.textContent='None assigned variables'; list.appendChild(empty);
    }
    g.vars.forEach(v=>{
      const row=document.createElement('div'); row.className='pill-row';
      const pill=document.createElement('span'); pill.className='pill'; pill.textContent=v; row.appendChild(pill);
      const rm=document.createElement('button'); rm.className='btn mini'; rm.textContent='Remove'; rm.onclick=()=>{ removeVarFromGroup(g.id, v); };
      const mv=document.createElement('button'); mv.className='btn mini'; mv.textContent='Move to'; mv.onclick=()=>{ chooseTargetGroup(g, v); };
      row.appendChild(rm); row.appendChild(mv); list.appendChild(row);
    });
  }
  updateVMFooter(g);
}

function updateVMFooter(g){
  $('#vmGroupName').textContent = 'Actual group name:  ' + (g? g.name: '-');
  $('#vmVarCount').textContent = 'Number of variables:  ' + (g? g.vars.length: 0);
}

function removeVarFromGroup(groupId, varName){
  const g = groups.find(x=>x.id===groupId); if(!g) return;
  g.vars = g.vars.filter(n=>n!==varName);
  unassigned[g.type].push(varName);
  refreshUI();
}

function chooseTargetGroup(sourceGroup, varName){
  const candidates = groups.filter(g=> g.type===sourceGroup.type && g.id!==sourceGroup.id);
  if(candidates.length===0){ $('#dlgWarn').style.display='flex'; return; }
  const box=$('#cgList'); box.innerHTML='';
  candidates.forEach(g=>{
    const b=document.createElement('button'); b.className='btn'; b.textContent=g.name; b.style.minWidth='140px'; b.style.margin='6px';
    b.onclick=()=>{ moveVar(sourceGroup, g, varName); $('#dlgChooseGroup').style.display='none'; };
    box.appendChild(b);
  });
  $('#dlgChooseGroup').style.display='flex';
}
function moveVar(from, to, varName){
  from.vars = from.vars.filter(n=>n!==varName);
  if(!to.vars.includes(varName)) to.vars.push(varName);
  refreshUI();
}

// Right side actions (act on selected group)
$('#btnCreateGroup').onclick=()=>{
  const g=groups.find(x=>x.id===vmSelectedGroupId) || groups[0];
  const sel=$('#ngType'); sel.innerHTML=''; TAB_ORDER.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); });
  $('#ngType').value = g? g.type : TAB_ORDER[0];
  $('#ngName').value = (g? g.type : TAB_ORDER[0]) + ' 2';
  $('#dlgNewGroup').style.display='flex';
};
$('#btnDeleteGroup').onclick=()=>{
  const g = groups.find(x=>x.id===vmSelectedGroupId); if(!g) return;
  g.vars.forEach(v=> unassigned[g.type].push(v));
  groups = groups.filter(x=>x.id!==g.id);
  vmSelectedGroupId = groups.find(x=>x.type===g.type)?.id || groups[0]?.id || null; refreshUI();
};
$('#btnRenameGroup').onclick=()=>{
  const g = groups.find(x=>x.id===vmSelectedGroupId); if(!g) return;
  const nn = prompt('Rename Group', g.name); if(!nn) return; g.name = nn.trim(); refreshUI();
};
$('#btnAddVariable').onclick=()=>{
  const g = groups.find(x=>x.id===vmSelectedGroupId); if(!g) return;
  const pool = unassigned[g.type];
  if(pool.length===0){ alert('No unassigned variable for this type.'); return; }
  $('#avGroupName').textContent = g.name;
  buildAddVarList(g.type); $('#dlgAddVar').style.display='flex';
};

function buildAddVarList(type){
  const list=$('#avList'); list.innerHTML='';
  const items = unassigned[type].slice();
  items.forEach(name=>{
    const row=document.createElement('div'); row.style.margin='6px 0';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.className='chk'; cb.value=name; row.appendChild(cb);
    const pill=document.createElement('span'); pill.className='pill'; pill.textContent=name + '  ('+type+')'; row.appendChild(pill);
    list.appendChild(row);
  });
  $('#avAllCount').textContent = items.length; updateSelCount();
}
function updateSelCount(){
  const n = $$('#avList input[type="checkbox"]:checked').length; $('#avSelCount').textContent = n;
}
$('#avList')?.addEventListener('change', updateSelCount);
$('#avAll').onclick=()=>{ $$('#avList input[type="checkbox"]').forEach(cb=> cb.checked=true); updateSelCount(); };
$('#avNone').onclick=()=>{ $$('#avList input[type="checkbox"]').forEach(cb=> cb.checked=false); updateSelCount(); };
$('#avCancel').onclick=()=> $('#dlgAddVar').style.display='none';
$('#avOK').onclick=()=>{
  const g = groups.find(x=>x.id===vmSelectedGroupId); if(!g) return;
  const chosen = $$('#avList input[type="checkbox"]:checked').map(cb=>cb.value);
  if(chosen.length===0){ $('#dlgAddVar').style.display='none'; return; }
  unassigned[g.type] = unassigned[g.type].filter(v=> !chosen.includes(v));
  chosen.forEach(v=>{ if(!g.vars.includes(v)) g.vars.push(v); });
  $('#dlgAddVar').style.display='none'; refreshUI();
};

// Sub dialog buttons
$('#ngCancel').onclick=()=> $('#dlgNewGroup').style.display='none';
$('#ngOK').onclick=()=>{
  const type=$('#ngType').value; const name=($('#ngName').value||'').trim()||type;
  const g={id:crypto.randomUUID(), type, name, vars:[], phases:[]};
  groups.push(g); sortGroups(); vmSelectedGroupId=g.id; $('#dlgNewGroup').style.display='none';
  // Offer Add Variable, but DO NOT discard here
  const pool = unassigned[type];
  if(pool && pool.length>0){
    $('#avGroupName').textContent = g.name; buildAddVarList(type); $('#dlgAddVar').style.display='flex';
  }
  refreshUI();
};
$('#cgCancel').onclick=()=> $('#dlgChooseGroup').style.display='none';
$('#warnOK').onclick=()=> $('#dlgWarn').style.display='none';

// ================= BUTTONS =================
$('#btnNew').addEventListener('click',()=>{
  protocol={ description:"", repeat:2147483647, logic:"23:00:00", sections:[{parts:[]}] };
  createDefaultGroups(); refreshUI();
  $('#dlgGroups').style.display='flex'; vmSelectedGroupId=groups[0].id; buildVM();
});
$('#btnErase').addEventListener('click',()=>{ if(!confirm('Erase current protocol?')) return; protocol=null; groups=[]; activeGroupId=null; unassigned={}; refreshUI(); });
$('#btnEraseTime').addEventListener('click',()=> $('#logic').value='- not set -');
$('#btnSetInf').addEventListener('click',()=> $('#repeat').value='Infinitely times');
$('#btnCloseGroups').onclick=()=>{
  // Discard any empty groups ONLY when finishing the VM overlay
  groups = groups.filter(g => Array.isArray(g.vars) && g.vars.length>0);
  if (!groups.find(x=>x.id===vmSelectedGroupId)) vmSelectedGroupId = groups[0]?.id || null;
  refreshUI();
  $('#dlgGroups').style.display='none';
};
$('#btnEditGroups').onclick=()=>{ if(!protocol){ alert('Create a NEW protocol first.'); return; } $('#dlgGroups').style.display='flex'; buildVM(); };

// initial paint
refreshUI();
</script>
</body>
</html>
